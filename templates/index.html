<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI BOOST</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        .header-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 19px 0;
            background-color: white;
            border-bottom: 1px solid #ddd;
            margin: 0;
            width: 100%;
        }

        .content-wrapper {
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .new-chat-btn {
            width: 100%;
            margin-top: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .conversation-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
        }

        .conversation-item:hover {
            background: #f8f9fa;
            border-color: #e0e0e0;
            transform: translateX(4px);
        }

        .conversation-item.active {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%);
            border-color: #28a745;
        }

        .conversation-title {
            font-weight: 500;
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-preview {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .conversation-time {
            font-size: 11px;
            color: #999;
        }

        .conversation-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }

        .delete-conversation {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .delete-conversation:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .empty-conversations {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-top: 50px;
        }

        .settings-section {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .settings-toggle {
            width: 100%;
            padding: 8px;
            background: none;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            transition: all 0.3s ease;
        }

        .settings-toggle:hover {
            background: #e9ecef;
        }

        .api-key-section, .file-upload-section {
            display: none;
            margin-top: 10px;
        }

        .api-key-section.show, .file-upload-section.show {
            display: block;
        }

        .main-chat {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 19px 0;
            background-color: white;
            border-bottom: 1px solid #ddd;
            margin: 0;
            width: 100%;
        }

        .logo {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 30px;
        }

        .logo-clean {
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }

        .logo-clean-right {
            position: absolute;
            right: 70px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
        }

        .logo img {
            height: 77px;
            width: auto;
            object-fit: contain;
        }

        .title {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin: 0;
            padding: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }

        .user-message {
            align-self: flex-end;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-left: 3px solid #28a745;
        }

        .assistant-message {
            align-self: flex-start;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-left: 3px solid #28a745;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #28a745;
        }

        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .api-key-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .api-key-section h3 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #28a745;
        }

        .status-indicator {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .file-upload-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .file-upload-section h3 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            border: 2px dashed #28a745;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        .loading {
            display: none;
            color: #28a745;
            font-style: italic;
            text-align: center;
            padding: 20px;
            margin: 10px 0;
        }

        .thinking-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-left: 3px solid #28a745;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e3e3e3;
            border-top: 5px solid #28a745;
            border-right: 5px solid #28a745;
            border-radius: 50%;
            animation: spin 0.8s linear infinite, pulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }

        .thinking-text {
            font-size: 16px;
            font-weight: 500;
            color: #28a745;
        }

        .thinking-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .typewriter {
            border-right: 2px solid #28a745;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { border-color: #28a745; }
            51%, 100% { border-color: transparent; }
        }

        .assistant-message.typing {
            position: relative;
        }

        .error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 12px;
            margin-top: 5px;
        }

        /* AI Status Window */
        .ai-status-window {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 200px;
            z-index: 1000;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .ai-status-window.collapsed {
            transform: translateX(calc(100% - 40px));
        }

        .ai-status-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .ai-status-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            flex: 1;
        }

        .ai-status-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.3s ease;
            font-size: 16px;
        }

        .ai-status-toggle:hover {
            background: #f8f9fa;
        }

        .ai-status-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ai-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .ai-status-label {
            color: #666;
            font-weight: 500;
        }

        .ai-status-value {
            color: #333;
            font-weight: 600;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .ai-status-badge {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token-progress {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }

        .token-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        @media (max-width: 768px) {
            .ai-status-window {
                top: 10px;
                right: 10px;
                min-width: 180px;
                padding: 12px;
            }

            .ai-status-title {
                font-size: 13px;
            }

            .ai-status-item {
                font-size: 11px;
            }
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 10px;
            }

            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 300px 1fr;
                gap: 10px;
                height: calc(100vh - 120px);
            }
            
            .sidebar {
                order: 1;
                max-height: 300px;
            }
            
            .main-chat {
                order: 2;
            }

            .sidebar-header h2 {
                font-size: 16px;
            }

            .conversation-item {
                padding: 8px;
            }

            .conversation-title {
                font-size: 13px;
            }

            .conversation-preview {
                font-size: 11px;
            }

            .logo-clean, .logo-clean-right {
                display: none;
            }

            .title {
                font-size: 24px;
            }
        }

        .copy-chat-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            padding: 0 20px;
        }

        .copy-chat-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .copy-chat-btn:hover {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        .copy-chat-btn:active {
            transform: translateY(0);
        }

        .copy-icon {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .copy-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
            color: white !important;
            border-color: #28a745 !important;
            animation: copyPulse 0.6s ease-out;
        }

        @keyframes copyPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            25% {
                transform: scale(1.05);
                box-shadow: 0 0 0 8px rgba(40, 167, 69, 0.4);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 12px rgba(40, 167, 69, 0.2);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 16px rgba(40, 167, 69, 0);
            }
        }
    </style>
</head>
<body>
    <!-- AI Status Window -->
    <div class="ai-status-window" id="aiStatusWindow">
        <div class="ai-status-header" onclick="toggleStatusWindow()">
            <div class="ai-status-title">AI Engine Status</div>
            <button class="ai-status-toggle" id="statusToggle">▼</button>
        </div>
        <div class="ai-status-content" id="statusContent">
            <div class="ai-status-item">
                <span class="ai-status-label">Model:</span>
                <span class="ai-status-value" id="currentModel">GPT-4o-mini</span>
            </div>
            <div class="ai-status-item">
                <span class="ai-status-label">Temperature:</span>
                <span class="ai-status-value" id="currentTemp">0.7</span>
            </div>
            <div class="ai-status-item">
                <span class="ai-status-label">Max Tokens:</span>
                <span class="ai-status-value" id="maxTokens">1,500</span>
            </div>
            <div class="ai-status-item">
                <span class="ai-status-label">Last Response:</span>
                <span class="ai-status-value" id="lastTokens">0</span>
            </div>
            <div class="ai-status-item">
                <span class="ai-status-label">Status:</span>
                <span class="ai-status-badge" id="aiStatus">Ready</span>
            </div>
            <div class="token-progress" title="Token usage progress">
                <div class="token-progress-bar" id="tokenProgressBar"></div>
            </div>
        </div>
    </div>

    <div class="header-container">
        <div class="logo logo-clean">
            <img src="https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcTQp9CsCdZ6lFTwb9RO4FLBRF5gDF1DuoBILJzmoyOiwi486qh3" alt="PEAKMADE Logo">
        </div>
        <div class="title">AI BOOST</div>
        <div class="logo logo-clean-right">
            <img src="https://media.licdn.com/dms/image/v2/C4E0BAQEeymUsYZLAcA/company-logo_200_200/company-logo_200_200/0/1670942774710?e=2147483647&v=beta&t=ydIqY4GhAC9VVs2gXIVfrruX6cwJLSExaORvpu-5Dno" alt="Redpoint CONNECT Logo">
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Chat History</h2>
                    <button onclick="startNewChat()" class="new-chat-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14m-7-7h14"></path>
                        </svg>
                        New Chat
                    </button>
                </div>
                
                <div class="conversations-list" id="conversationsList">
                    <div class="empty-conversations">
                        Start a new conversation to see your chat history here.
                    </div>
                </div>
                
                <div class="settings-section">
                    <button onclick="toggleSettings()" class="settings-toggle" id="settingsToggle">
                        ⚙️ Settings & API Key
                    </button>
                    
                    <div class="api-key-section" id="apiKeySection">
                        <h4 style="margin: 10px 0 5px 0; font-size: 14px;">OpenAI API Key</h4>
                        <textarea id="apiKey" class="api-key-input" placeholder="Enter your OpenAI API key here..." rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"></textarea>
                        <div id="apiStatus" class="status-indicator status-disconnected" style="margin-top: 5px; font-size: 11px;">Not Connected</div>
                    </div>

                    <div class="file-upload-section" id="fileUploadSection">
                        <h4 style="margin: 10px 0 5px 0; font-size: 14px;">Upload File</h4>
                        <input type="file" id="fileInput" class="file-input" accept=".pdf,.txt" style="width: 100%; margin-bottom: 8px;">
                        <button onclick="uploadFile()" class="btn btn-secondary" style="width: 100%; font-size: 12px; padding: 6px;">Upload</button>
                        <div id="uploadStatus"></div>
                    </div>
                </div>
            </div>

            <div class="main-chat">

            <div id="chatMessages" class="chat-messages">
                <div class="assistant-message">
                    <strong>AI Assistant:</strong> Hello! I'm AI BOOST, your advanced AI assistant with knowledge updated through 2025. I can help you with current information, recent developments, and analyze documents. Please enter your OpenAI API key in the sidebar to get started. You can also upload PDF or text files for me to analyze.
                </div>
            </div>

            <div class="chat-input-container">
                <div class="input-group">
                    <input type="text" id="messageInput" class="chat-input" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                    <div class="input-actions">
                        <button onclick="sendMessage()" class="btn">Send</button>
                        <button onclick="copyFullChat()" class="copy-chat-btn" id="copyChatBtn" title="Copy entire chat">
                            <svg class="copy-icon" viewBox="0 0 24 24">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            Copy
                        </button>
                    </div>
                </div>
                <div id="thinking" class="thinking-container" style="display: none;">
                    <div class="spinner"></div>
                    <div class="thinking-text">AI is thinking<span class="thinking-dots"></span></div>
                </div>
                <div id="errorMessage" class="error"></div>
            </div>
        </div>
        </div>
    </div>

    <script>
        let uploadedContent = '';
        let currentConversationId = null;
        let conversations = JSON.parse(localStorage.getItem('chatConversations') || '[]');
        
        // AI Status Window Management
        function toggleStatusWindow() {
            const statusWindow = document.getElementById('aiStatusWindow');
            const statusContent = document.getElementById('statusContent');
            const statusToggle = document.getElementById('statusToggle');
            
            if (statusWindow.classList.contains('collapsed')) {
                statusWindow.classList.remove('collapsed');
                statusToggle.textContent = '▼';
            } else {
                statusWindow.classList.add('collapsed');
                statusToggle.textContent = '◀';
            }
        }

        function updateAIStatus(status, tokensUsed = null) {
            const statusBadge = document.getElementById('aiStatus');
            const lastTokens = document.getElementById('lastTokens');
            const progressBar = document.getElementById('tokenProgressBar');
            
            // Update status badge
            statusBadge.textContent = status;
            statusBadge.className = 'ai-status-badge';
            
            // Color coding for different statuses
            if (status === 'Thinking...') {
                statusBadge.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
            } else if (status === 'Ready') {
                statusBadge.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            } else if (status === 'Error') {
                statusBadge.style.background = 'linear-gradient(135deg, #dc3545 0%, #e74c3c 100%)';
            }
            
            // Update token usage
            if (tokensUsed !== null) {
                lastTokens.textContent = tokensUsed.toLocaleString();
                
                // Update progress bar (assuming 1500 max tokens)
                const maxTokens = 1500;
                const percentage = Math.min((tokensUsed / maxTokens) * 100, 100);
                progressBar.style.width = percentage + '%';
                
                // Change color based on usage
                if (percentage > 80) {
                    progressBar.style.background = 'linear-gradient(135deg, #dc3545 0%, #e74c3c 100%)';
                } else if (percentage > 60) {
                    progressBar.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
                } else {
                    progressBar.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                }
            }
        }

        function estimateTokens(text) {
            // Rough estimation: ~4 characters per token
            return Math.ceil(text.length / 4);
        }
        
        // Conversation Management
        function generateConversationId() {
            return 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveConversation() {
            if (!currentConversationId) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const messages = Array.from(chatMessages.children).map(msg => ({
                content: msg.innerHTML,
                isUser: msg.classList.contains('user-message'),
                timestamp: Date.now()
            }));

            if (messages.length <= 1) return; // Don't save if only welcome message

            const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
            const firstUserMessage = messages.find(m => m.isUser);
            const title = firstUserMessage ? 
                firstUserMessage.content.replace(/<[^>]*>/g, '').substring(0, 50) + '...' : 
                'New Conversation';

            const conversation = {
                id: currentConversationId,
                title: title,
                messages: messages,
                lastUpdated: Date.now(),
                preview: firstUserMessage ? firstUserMessage.content.replace(/<[^>]*>/g, '').substring(0, 100) : 'No messages'
            };

            if (existingIndex >= 0) {
                conversations[existingIndex] = conversation;
            } else {
                conversations.unshift(conversation);
            }

            // Keep only last 20 conversations
            conversations = conversations.slice(0, 20);
            localStorage.setItem('chatConversations', JSON.stringify(conversations));
            renderConversationsList();
        }

        function loadConversation(conversationId) {
            const conversation = conversations.find(c => c.id === conversationId);
            if (!conversation) return;

            // Save current conversation before switching
            if (currentConversationId && currentConversationId !== conversationId) {
                saveConversation();
            }

            currentConversationId = conversationId;
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            conversation.messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.className = msg.isUser ? 'user-message message' : 'assistant-message message';
                messageEl.innerHTML = msg.content;
                chatMessages.appendChild(messageEl);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;
            renderConversationsList();
        }

        function deleteConversation(conversationId, event) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this conversation?')) {
                conversations = conversations.filter(c => c.id !== conversationId);
                localStorage.setItem('chatConversations', JSON.stringify(conversations));
                
                if (currentConversationId === conversationId) {
                    startNewChat();
                }
                
                renderConversationsList();
            }
        }

        function startNewChat() {
            // Save current conversation
            if (currentConversationId) {
                saveConversation();
            }

            currentConversationId = generateConversationId();
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="assistant-message">
                    <strong>AI Assistant:</strong> Hello! I'm AI BOOST, your advanced AI assistant with knowledge updated through 2025. I can help you with current information, recent developments, and analyze documents. How can I assist you today?
                </div>
            `;
            renderConversationsList();
        }

        function formatTime(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        function renderConversationsList() {
            const listEl = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                listEl.innerHTML = '<div class="empty-conversations">Start a new conversation to see your chat history here.</div>';
                return;
            }

            listEl.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${conv.id === currentConversationId ? 'active' : ''}" 
                     onclick="loadConversation('${conv.id}')">
                    <div class="conversation-title">${conv.title}</div>
                    <div class="conversation-preview">${conv.preview}</div>
                    <div class="conversation-time">${formatTime(conv.lastUpdated)}</div>
                    <div class="conversation-actions">
                        <button class="delete-conversation" onclick="deleteConversation('${conv.id}', event)">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="M8,6V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2V6M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function toggleSettings() {
            const apiSection = document.getElementById('apiKeySection');
            const fileSection = document.getElementById('fileUploadSection');
            const toggle = document.getElementById('settingsToggle');
            
            if (apiSection.classList.contains('show')) {
                apiSection.classList.remove('show');
                fileSection.classList.remove('show');
                toggle.textContent = '⚙️ Settings & API Key';
            } else {
                apiSection.classList.add('show');
                fileSection.classList.add('show');
                toggle.textContent = '⚙️ Hide Settings';
            }
        }

        // Initialize conversations on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!currentConversationId) {
                currentConversationId = generateConversationId();
            }
            renderConversationsList();
            
            // Initialize AI status window
            updateAIStatus('Ready');
        });
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function updateApiStatus() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusEl = document.getElementById('apiStatus');
            
            if (apiKey) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status-indicator status-connected';
            } else {
                statusEl.textContent = 'Not Connected';
                statusEl.className = 'status-indicator status-disconnected';
            }
        }

        document.getElementById('apiKey').addEventListener('input', updateApiStatus);

        function resetCopyButton() {
            const btn = document.getElementById('copyChatBtn');
            if (btn.classList.contains('copy-success')) {
                btn.innerHTML = `
                    <svg class="copy-icon" viewBox="0 0 24 24">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy
                `;
                btn.classList.remove('copy-success');
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                showError('Please enter a message');
                return;
            }

            // Check if we have environment API key or user input
            const apiKeyInput = document.getElementById('apiKey');
            const apiKey = apiKeyInput.value.trim();
            const apiKeySection = document.querySelector('.api-key-section');
            const hasEnvironmentKey = apiKeySection && apiKeySection.style.display === 'none';
            
            // Only require API key input if environment key is not available
            if (!hasEnvironmentKey && !apiKey) {
                showError('Please enter your OpenAI API key');
                return;
            }

            // Clear input and show thinking animation
            messageInput.value = '';
            showThinking(true);
            clearError();
            
            // Update AI status to thinking
            updateAIStatus('Thinking...');
            
            // Reset copy button since chat is changing
            resetCopyButton();

            // Add user message to chat
            addMessageToChat('user', message);

            try {
                // Get API key for request (empty string if using environment key)
                const apiKeyForRequest = hasEnvironmentKey ? '' : apiKey;
                
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        api_key: apiKeyForRequest,
                        uploaded_content: uploadedContent
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Estimate tokens used in response
                    const estimatedTokens = estimateTokens(data.ai_response);
                    
                    // Update AI status to ready with token count
                    updateAIStatus('Ready', estimatedTokens);
                    
                    // Add AI message with typewriter effect
                    addMessageToChatWithTypewriter('assistant', data.ai_response);
                    // Save conversation after successful response
                    setTimeout(() => saveConversation(), 1000);
                } else {
                    updateAIStatus('Error');
                    showError(data.error || 'An error occurred');
                }
            } catch (error) {
                updateAIStatus('Error');
                showError('Network error: ' + error.message);
            } finally {
                showThinking(false);
            }
        }

        function addMessageToChat(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            const roleLabel = role === 'user' ? 'You' : 'AI Assistant';
            messageDiv.innerHTML = `<strong>${roleLabel}:</strong> ${content}`;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addMessageToChatWithTypewriter(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message typing`;
            
            const roleLabel = role === 'user' ? 'You' : 'AI Assistant';
            const contentSpan = document.createElement('span');
            contentSpan.className = 'typewriter';
            
            messageDiv.innerHTML = `<strong>${roleLabel}:</strong> `;
            messageDiv.appendChild(contentSpan);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Typewriter effect
            let index = 0;
            const typeSpeed = 30; // milliseconds between characters
            
            function typeCharacter() {
                if (index < content.length) {
                    contentSpan.textContent += content.charAt(index);
                    index++;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    setTimeout(typeCharacter, typeSpeed);
                } else {
                    // Remove typewriter cursor when done
                    contentSpan.classList.remove('typewriter');
                    messageDiv.classList.remove('typing');
                }
            }
            
            // Start typing after a short delay
            setTimeout(typeCharacter, 300);
        }

        // Check API key status on page load
        async function checkApiKeyStatus() {
            try {
                const response = await fetch('/api-key-status');
                const data = await response.json();
                
                if (data.has_environment_key) {
                    // Hide API key input if environment variable is configured
                    const apiKeySection = document.querySelector('.api-key-section');
                    if (apiKeySection) {
                        apiKeySection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.log('Could not check API key status:', error);
            }
        }

        function showThinking(show) {
            document.getElementById('thinking').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
        }

        function clearError() {
            document.getElementById('errorMessage').textContent = '';
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showUploadStatus('Please select a file', 'error');
                return;
            }

            showUploadStatus('Uploading...', 'loading');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    uploadedContent = data.full_content;
                    showUploadStatus(`File "${data.filename}" uploaded successfully!`, 'success');
                    fileInput.value = ''; // Clear file input
                } else {
                    showUploadStatus(data.error || 'Upload failed', 'error');
                }
            } catch (error) {
                showUploadStatus('Upload error: ' + error.message, 'error');
            }
        }

        function showUploadStatus(message, type) {
            const statusEl = document.getElementById('uploadStatus');
            statusEl.textContent = message;
            statusEl.className = type;
        }

        async function clearChat() {
            // Use the startNewChat function instead
            startNewChat();
        }

        function copyFullChat() {
            const btn = document.getElementById('copyChatBtn');
            
            // If already in copied state, reset to normal
            if (btn.classList.contains('copy-success')) {
                btn.innerHTML = `
                    <svg class="copy-icon" viewBox="0 0 24 24">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy
                `;
                btn.classList.remove('copy-success');
                return;
            }
            
            // Proceed with copying
            const chatMessages = document.getElementById('chatMessages');
            const messages = chatMessages.querySelectorAll('.user-message, .assistant-message');
            
            let chatText = 'AI BOOST Chat Conversation\n';
            chatText += '================================\n\n';
            
            messages.forEach((message, index) => {
                const isUser = message.classList.contains('user-message');
                const isAssistant = message.classList.contains('assistant-message');
                
                if (isUser) {
                    const content = message.textContent.replace('You: ', '').trim();
                    chatText += `👤 User: ${content}\n\n`;
                } else if (isAssistant) {
                    const content = message.textContent.replace('AI Assistant: ', '').trim();
                    chatText += `🤖 AI Assistant: ${content}\n\n`;
                }
            });
            
            chatText += `Generated on: ${new Date().toLocaleString()}\n`;
            chatText += 'Powered by AI BOOST - PeakMade Real Estate';
            
            // Copy to clipboard
            navigator.clipboard.writeText(chatText).then(() => {
                // Show success feedback - stays until clicked again
                btn.innerHTML = `
                    <svg class="copy-icon" viewBox="0 0 24 24">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                    Copied!
                `;
                btn.classList.add('copy-success');
                // No timeout - stays green until clicked again
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = chatText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                // Show success state for fallback too
                btn.innerHTML = `
                    <svg class="copy-icon" viewBox="0 0 24 24">
                        <path d="M20 6L9 17l-5-5"></path>
                    </svg>
                    Copied!
                `;
                btn.classList.add('copy-success');
            });
        }

        // Load existing messages on page load
        window.addEventListener('load', async () => {
            // Check API key status first
            await checkApiKeyStatus();
            
            try {
                const response = await fetch('/get_messages');
                const data = await response.json();
                
                if (data.api_key) {
                    document.getElementById('apiKey').value = data.api_key;
                    updateApiStatus();
                }
                
                if (data.messages && data.messages.length > 0) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    
                    data.messages.forEach(msg => {
                        addMessageToChat(msg.role, msg.content);
                    });
                }
            } catch (error) {
                console.log('No existing session data');
            }
        });
    </script>
</body>
</html>
